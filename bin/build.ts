#!/usr/bin/env node

const path = require('path');
const { rmSync, readFileSync, readdirSync } = require('fs');

type Webpack = typeof import('webpack');

type Configuration = Parameters<Webpack>[0][number];

(async function () {
  // @ts-ignore
  const { default: webpack } = (await import('webpack')) as unknown as {
    default: Webpack;
  };
  // @ts-ignore
  const { default: chalk } = await import('chalk');

  if (!process.argv[2]) {
    throw new Error(chalk.red("Main filename can't be undefined"));
  }

  const DIST_DIR = path.resolve(process.cwd(), 'dist');

  const filename = path.resolve('.', process.argv[2]);

  if (process.argv.includes('--clean')) {
    try {
      rmSync(DIST_DIR, { recursive: true, force: true });
    } catch {
      //
    }
  }

  const V7 = process.argv.includes('--v7');

  const helperPackage = require(
    path.resolve(__dirname, '..', '..', 'package.json'),
  );

  const packageFile: {
    [p: string]: any;
  } = require(path.resolve(process.cwd(), 'package.json'));
  const packageDir = readdirSync(process.cwd(), {
    encoding: 'utf-8',
    flag: 'r',
  });

  const presetEnv = V7
    ? {
        useBuiltIns: 'entry',
        corejs: '3.8',
        targets: {
          chrome: 97, // January 2022 - supports async/await
        },
        modules: false,
      }
    : {
        targets: 'ie 11',
      };

  const compiler = webpack({
    mode: 'production',
    plugins: [
      new webpack.BannerPlugin({
        banner: function () {
          const { repository, name, version } = packageFile;

          let readme!: string;

          if (packageDir.length) {
            const regExp = /^readme\.md$/i;

            for (const object of packageDir) {
              if (regExp.test(object)) {
                readme = readFileSync(object, { encoding: 'utf-8', flag: 'r' });

                break;
              }
            }
          }

          if (!repository) {
            console.warn(
              chalk.yellow(
                'Please define "repository" field in you package.json file',
              ),
            );
          }

          let helperRepository = '';

          if (typeof helperPackage.repository === 'string') {
            helperRepository = helperPackage.repository;
          } else if (typeof helperPackage.repository === 'object') {
            helperRepository = helperPackage.repository.url?.slice(
              helperPackage.repository.url?.indexOf('http'),
            );
          }

          return `***** DO NOT EDIT! THIS CODE IS GENERATED BY THE PACKAGE ${
            helperPackage.name
          } (${helperRepository}) *****

Please, go to code sources and add your changes!

Code sources:
  Package name: ${name}
  Package version: ${version}
  Package repository: ${repository ? repository : 'Not defined'}
  Build command: npm run ${process.env.npm_lifecycle_event}
  Built at: ${new Date().toISOString()}
  ${V7 ? 'Compatibility: v7 ONLY\n' : ''}
***** ----- ----- ----- ----- ----- ----- *****
${readme ? `\n***** README.md *****\n\n${readme}\n***** --------- *****` : ''}`;
        },
      }),
      new webpack.NormalModuleReplacementPlugin(/-TARGET_EXTENSION$/, function (
        resource,
      ) {
        resource.request = resource.request.replace(
          /-TARGET_EXTENSION/,
          `-${V7 ? 'v7' : 'v6'}`,
        );

        if (resource.createData) {
          resource.createData.request = resource.request;
        }
      }),
    ],
    optimization: { minimize: false },
    target: ['web', !V7 ? 'es5' : 'es2023'],
    entry: filename,
    output: {
      path: DIST_DIR,
      filename: `${path.parse(filename).name}.js`,
    },
    stats: 'errors-warnings',
    module: {
      rules: [
        {
          test: /\.tsx?$/,
          exclude: /node_modules/,
          use: {
            loader: 'babel-loader',
            options: {
              presets: [
                ['@babel/preset-env', presetEnv],
                '@babel/preset-typescript',
              ],
            },
          },
        },
        {
          test: /\.[mc]?js$/,
          exclude: {
            not: [/node_modules/],
          },
          use: {
            loader: 'babel-loader',
            options: {
              presets: [['@babel/preset-env', presetEnv]],
            },
          },
        },
      ],
    },
    resolve: {
      extensions: ['.tsx', '.ts', '.js', '.mjs', '.cjs'],
    },
  } satisfies Configuration);

  await new Promise<{
    err: Parameters<Parameters<typeof compiler.run>[0]>[0];
    stats: Parameters<Parameters<typeof compiler.run>[0]>[1];
  }>((resolve) => {
    compiler.run((err, stats) => resolve({ err, stats }));
  }).then(({ err, stats }) => {
    if (err || stats?.hasErrors()) {
      if (err) {
        console.error(err);
      } else {
        console.log(stats?.toString({ colors: true }));
      }

      console.log(chalk.red('Code compiled with error'));
    } else {
      console.log(stats?.toString({ colors: true }));
      console.log(chalk.green('Done'));
    }
  });
})();
